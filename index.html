<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Consultoria Â· CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap"
    rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg: #0a0d12;
      --surface: #111520;
      --surface2: #161b27;
      --surface3: #1c2235;
      --border: #252d40;
      --border2: #2e3850;
      --accent: #c8a96e;
      --accent-dim: rgba(200, 169, 110, 0.12);
      --accent-glow: rgba(200, 169, 110, 0.3);
      --text: #e8eaf0;
      --text2: #9aa0b4;
      --text3: #606880;
      --green: #4caf82;
      --green-dim: rgba(76, 175, 130, 0.12);
      --red: #e05c6a;
      --red-dim: rgba(224, 92, 106, 0.12);
      --blue: #5b9cf6;
      --blue-dim: rgba(91, 156, 246, 0.12);
      --purple: #9b72cf;
      --purple-dim: rgba(155, 114, 207, 0.12);
      --orange: #e8884a;
      --orange-dim: rgba(232, 136, 74, 0.12);
      --r: 10px;
      --rl: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 9px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #config-screen {
      position: fixed;
      inset: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      background-image: radial-gradient(ellipse 60% 50% at 70% 50%, rgba(200, 169, 110, 0.07) 0%, transparent 70%);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #login-screen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      background-image: radial-gradient(ellipse 60% 50% at 70% 50%, rgba(200, 169, 110, 0.07) 0%, transparent 70%);
    }

    .auth-box {
      width: 420px;
      padding: 48px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(200, 169, 110, 0.08);
      animation: fadeUp .5s ease;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .monogram {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--accent), #9a6e28);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: #0a0d12;
      box-shadow: 0 4px 16px rgba(200, 169, 110, 0.35);
    }

    .brand-name {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 700;
    }

    .brand-sub {
      font-size: 10px;
      color: var(--text3);
      letter-spacing: .07em;
      text-transform: uppercase;
    }

    .auth-box h2 {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .auth-box p {
      color: var(--text2);
      font-size: 13.5px;
      margin-bottom: 28px;
    }

    .fg {
      margin-bottom: 14px;
    }

    .fg label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text3);
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    .fg input,
    .fg select,
    .fg textarea {
      width: 100%;
      padding: 11px 15px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    .fg input:focus,
    .fg select:focus,
    .fg textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .fg select option {
      background: var(--surface2);
    }

    .fg textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn-main {
      width: 100%;
      padding: 13px;
      margin-top: 6px;
      background: linear-gradient(135deg, var(--accent), #9a6e28);
      border: none;
      border-radius: var(--r);
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #0a0d12;
      transition: transform .2s, box-shadow .2s;
    }

    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    .btn-main:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    .auth-err {
      margin-top: 12px;
      padding: 10px 14px;
      background: var(--red-dim);
      border: 1px solid rgba(224, 92, 106, .2);
      border-radius: var(--r);
      font-size: 13px;
      color: var(--red);
      display: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #app {
      display: flex;
      height: 100vh;
      opacity: 0;
      transition: opacity .4s;
    }

    #app.visible {
      opacity: 1;
    }

    /* SIDEBAR */
    #sidebar {
      width: 238px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .sb-header {
      padding: 22px 18px 18px;
      border-bottom: 1px solid var(--border);
    }

    .sb-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sb-logo .monogram {
      width: 34px;
      height: 34px;
      font-size: 15px;
      border-radius: 8px;
    }

    .sb-nav {
      flex: 1;
      padding: 14px 0;
      overflow-y: auto;
    }

    .nav-section-lbl {
      padding: 8px 18px 3px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text3);
      letter-spacing: .1em;
      text-transform: uppercase;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 18px;
      cursor: pointer;
      font-size: 13.5px;
      font-weight: 500;
      color: var(--text2);
      border-left: 2px solid transparent;
      transition: all .15s;
      user-select: none;
    }

    .nav-item:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .nav-item.active {
      color: var(--accent);
      background: var(--accent-dim);
      border-left-color: var(--accent);
    }

    .nav-item .ico {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .nav-badge {
      margin-left: auto;
      padding: 2px 7px;
      border-radius: 99px;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
    }

    .nb-red {
      background: var(--red);
    }

    .nb-green {
      background: var(--green);
    }

    .nb-orange {
      background: var(--orange);
    }

    .sb-foot {
      padding: 14px 16px;
      border-top: 1px solid var(--border);
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 9px 11px;
      background: var(--surface2);
      border-radius: var(--r);
      cursor: default;
    }

    .user-av {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--accent), #9a6e28);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #0a0d12;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 10px;
      color: var(--text3);
    }

    .logout-x {
      color: var(--text3);
      cursor: pointer;
      font-size: 14px;
      padding: 3px;
      border-radius: 4px;
      transition: color .15s;
    }

    .logout-x:hover {
      color: var(--red);
    }

    /* MAIN */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #topbar {
      padding: 14px 26px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 21px;
      font-weight: 700;
      flex: 1;
    }

    #topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #content {
      flex: 1;
      overflow-y: auto;
      padding: 26px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: var(--r);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
      border: none;
      outline: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #9a6e28);
      color: #0a0d12;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px var(--accent-glow);
    }

    .btn-outline {
      background: transparent;
      color: var(--text2);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      border-color: var(--border2);
      color: var(--text);
      background: var(--surface2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text2);
    }

    .btn-ghost:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .btn-danger {
      background: var(--red-dim);
      color: var(--red);
      border: 1px solid rgba(224, 92, 106, .2);
    }

    .btn-danger:hover {
      background: var(--red);
      color: #fff;
    }

    .btn-sm {
      padding: 5px 11px;
      font-size: 12px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: 22px;
    }

    .card-sm {
      padding: 14px;
    }

    /* KPI */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 26px;
    }

    .kpi {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
      transition: transform .15s, border-color .15s;
    }

    .kpi:hover {
      transform: translateY(-2px);
      border-color: var(--border2);
    }

    .kpi::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--kc, var(--accent)), transparent);
    }

    .kpi-lbl {
      font-size: 10.5px;
      font-weight: 600;
      color: var(--text3);
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-bottom: 9px;
    }

    .kpi-val {
      font-family: 'Playfair Display', serif;
      font-size: 26px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 7px;
    }

    .kpi-sub {
      font-size: 11.5px;
      color: var(--text2);
    }

    .kpi-ico {
      position: absolute;
      right: 16px;
      top: 16px;
      font-size: 20px;
      opacity: .25;
    }

    /* BADGE */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 9px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .bg-green {
      background: var(--green-dim);
      color: var(--green);
    }

    .bg-red {
      background: var(--red-dim);
      color: var(--red);
    }

    .bg-blue {
      background: var(--blue-dim);
      color: var(--blue);
    }

    .bg-orange {
      background: var(--orange-dim);
      color: var(--orange);
    }

    .bg-purple {
      background: var(--purple-dim);
      color: var(--purple);
    }

    .bg-gray {
      background: rgba(144, 152, 176, .1);
      color: var(--text2);
    }

    .bg-accent {
      background: var(--accent-dim);
      color: var(--accent);
    }

    /* TABLE */
    .tbl-wrap {
      overflow-x: auto;
      border-radius: var(--rl);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead tr {
      border-bottom: 1px solid var(--border);
    }

    thead th {
      padding: 11px 15px;
      text-align: left;
      font-size: 10.5px;
      font-weight: 600;
      color: var(--text3);
      letter-spacing: .08em;
      text-transform: uppercase;
      background: var(--surface2);
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .12s;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--surface2);
    }

    tbody td {
      padding: 13px 15px;
      font-size: 13.5px;
      color: var(--text);
    }

    /* KANBAN */
    .kanban-wrap {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 6px;
      min-height: 480px;
    }

    .k-col {
      flex-shrink: 0;
      width: 232px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      display: flex;
      flex-direction: column;
    }

    .k-head {
      padding: 13px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .k-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    .k-title {
      font-size: 12.5px;
      font-weight: 600;
      flex: 1;
    }

    .k-cnt {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      background: var(--surface3);
      border-radius: 99px;
      color: var(--text2);
    }

    .k-cards {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      overflow-y: auto;
    }

    .k-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 13px;
      cursor: pointer;
      transition: border-color .15s, transform .15s, box-shadow .15s;
    }

    .k-card:hover {
      border-color: var(--border2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
    }

    .k-card-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .k-card-sub {
      font-size: 11.5px;
      color: var(--text2);
      margin-bottom: 9px;
    }

    .k-card-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .k-card-val {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
    }

    .k-card-date {
      font-size: 10.5px;
      color: var(--text3);
    }

    .k-add {
      margin: 6px 10px 10px;
      padding: 8px;
      border-radius: var(--r);
      border: 1px dashed var(--border2);
      background: transparent;
      color: var(--text3);
      cursor: pointer;
      font-size: 12px;
      font-family: 'DM Sans', sans-serif;
      transition: all .15s;
      text-align: center;
    }

    .k-add:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim);
    }

    /* SEARCH */
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
    }

    .search-wrap input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13.5px;
      width: 200px;
    }

    .search-wrap input::placeholder {
      color: var(--text3);
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0, 0, 0, .72);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn .18s ease;
    }

    .modal {
      width: 520px;
      max-height: 88vh;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      box-shadow: 0 32px 80px rgba(0, 0, 0, .6);
      animation: slideUp .22s ease;
    }

    .modal-lg {
      width: 640px;
    }

    .modal-head {
      padding: 20px 22px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 700;
    }

    .modal-x {
      cursor: pointer;
      color: var(--text3);
      font-size: 17px;
      transition: color .15s;
    }

    .modal-x:hover {
      color: var(--red);
    }

    .modal-body {
      padding: 22px;
    }

    .modal-foot {
      padding: 14px 22px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 9px;
      justify-content: flex-end;
    }

    /* FORM GRID */
    .fr {
      display: grid;
      gap: 14px;
      margin-bottom: 14px;
    }

    .fr-2 {
      grid-template-columns: 1fr 1fr;
    }

    .fr-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .fr-1 {
      grid-template-columns: 1fr;
    }

    .field label {
      display: block;
      font-size: 10.5px;
      font-weight: 600;
      color: var(--text3);
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 9px 13px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13.5px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .field select option {
      background: var(--surface2);
    }

    .field textarea {
      resize: vertical;
      min-height: 76px;
    }

    .checks {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }

    .checks label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .checks input[type=checkbox] {
      accent-color: var(--accent);
    }

    /* PROGRESS */
    .prog-bar {
      height: 5px;
      background: var(--surface3);
      border-radius: 99px;
      overflow: hidden;
    }

    .prog-fill {
      height: 100%;
      border-radius: 99px;
      transition: width .5s ease;
    }

    /* SECTION HEADER */
    .sh {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .sh-title {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 700;
    }

    .sh-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* EMPTY STATE */
    .empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 56px 40px;
      gap: 12px;
      color: var(--text3);
      text-align: center;
    }

    .empty .ei {
      font-size: 38px;
      opacity: .4;
    }

    .empty p {
      font-size: 13.5px;
      max-width: 260px;
      line-height: 1.6;
    }

    /* LOADING */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      gap: 12px;
      color: var(--text2);
      font-size: 14px;
    }

    .spinner {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast-item {
      padding: 12px 18px;
      border-radius: var(--r);
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .5);
      animation: slideUp .25s ease;
      border-left: 3px solid;
    }

    .toast-ok {
      background: var(--surface);
      color: var(--text);
      border-color: var(--green);
    }

    .toast-err {
      background: var(--surface);
      color: var(--text);
      border-color: var(--red);
    }

    .toast-info {
      background: var(--surface);
      color: var(--text);
      border-color: var(--accent);
    }

    /* IA */
    .ia-wrap {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 175px);
    }

    .ia-msgs {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding-right: 4px;
    }

    .ia-msg {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .ia-msg.user {
      flex-direction: row-reverse;
    }

    .ia-bubble {
      max-width: 72%;
      padding: 11px 15px;
      border-radius: 12px;
      font-size: 13.5px;
      line-height: 1.65;
    }

    .ia-bubble.assistant {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px 12px 12px 12px;
    }

    .ia-bubble.user {
      background: var(--accent-dim);
      border: 1px solid rgba(200, 169, 110, .2);
      border-radius: 12px 4px 12px 12px;
    }

    .ia-av {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 13px;
    }

    .ia-av.ai {
      background: linear-gradient(135deg, var(--accent), #9a6e28);
      color: #0a0d12;
      font-weight: 700;
    }

    .ia-av.usr {
      background: var(--surface3);
      color: var(--text2);
    }

    .ia-input-row {
      display: flex;
      gap: 9px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      margin-top: 14px;
    }

    .ia-input-row textarea {
      flex: 1;
      padding: 11px 15px;
      resize: none;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13.5px;
      outline: none;
      min-height: 46px;
      max-height: 120px;
      transition: border-color .2s, box-shadow .2s;
    }

    .ia-input-row textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .ia-quick {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    /* DIVIDER */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 18px 0;
    }

    /* TICKET */
    .tk-priority {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .interacao-item {
      padding: 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      margin-bottom: 10px;
    }

    .int-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .int-autor {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
    }

    .int-data {
      font-size: 11px;
      color: var(--text3);
    }

    .int-texto {
      font-size: 13.5px;
      line-height: 1.6;
    }

    /* FIN */
    .fin-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 26px;
    }

    .fin-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: 18px 20px;
    }

    .fin-lbl {
      font-size: 10.5px;
      font-weight: 600;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 8px;
    }

    .fin-val {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
    }

    /* ANIMATIONS */
    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(22px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(16px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    /* UTILS */
    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-8 {
      gap: 8px;
    }

    .gap-12 {
      gap: 12px;
    }

    .gap-16 {
      gap: 16px;
    }

    .mb-8 {
      margin-bottom: 8px;
    }

    .mb-14 {
      margin-bottom: 14px;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .mb-26 {
      margin-bottom: 26px;
    }

    .text-sm {
      font-size: 12.5px;
    }

    .text-xs {
      font-size: 11px;
      color: var(--text3);
    }

    .text-muted {
      color: var(--text2);
    }

    .fw-600 {
      font-weight: 600;
    }

    .fw-700 {
      font-weight: 700;
    }

    .w-full {
      width: 100%;
    }

    .font-serif {
      font-family: 'Playfair Display', serif;
    }
  </style>
</head>

<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONFIG SCREEN (primeira vez)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="config-screen">
    <div class="auth-box" style="width:480px">
      <div class="logo-row">
        <div class="monogram">A</div>
        <div>
          <div class="brand-name">AM Consultoria</div>
          <div class="brand-sub">Dados Â· IA Â· AutomaÃ§Ã£o</div>
        </div>
      </div>
      <h2>ConfiguraÃ§Ã£o Inicial</h2>
      <p>Insira as credenciais do Supabase para conectar ao banco de dados.</p>
      <div class="fg">
        <label>Supabase URL</label>
        <input id="sb-url" placeholder="https://xxxxxxxxxxxx.supabase.co" autocomplete="off">
      </div>
      <div class="fg">
        <label>Supabase Anon Key</label>
        <input id="sb-key" placeholder="eyJhbGciOi..." autocomplete="off">
      </div>
      <button class="btn-main" onclick="saveConfig()" style="margin-top:16px;">Salvar e Conectar</button>
      <div id="cfg-err" class="auth-err"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="login-screen">
    <div class="auth-box">
      <div class="logo-row">
        <div class="monogram">A</div>
        <div>
          <div class="brand-name">AM Consultoria</div>
          <div class="brand-sub">CRM Â· v2.0</div>
        </div>
      </div>
      <h2>Bem-vindo de volta</h2>
      <p>Acesse o painel de gestÃ£o da sua consultoria.</p>
      <div class="fg"><label>E-mail</label><input id="l-email" type="email" placeholder="seu@email.com"></div>
      <div class="fg"><label>Senha</label><input id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="btn-main" id="login-btn" onclick="doLogin()">Entrar</button>
      <div id="login-err" class="auth-err"></div>
      <div style="margin-top:16px;text-align:center">
        <span style="font-size:12px;color:var(--text3);cursor:pointer" onclick="clearConfig()">âš™ Reconfigurar
          credenciais</span>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="sb-header">
        <div class="sb-logo">
          <div class="monogram">A</div>
          <div>
            <div class="brand-name" style="font-size:14px">AM Consultoria</div>
            <div class="brand-sub">CRM v2.0</div>
          </div>
        </div>
      </div>

      <nav class="sb-nav">
        <div class="nav-section-lbl">Principal</div>
        <div class="nav-item active" data-page="dashboard">
          <span class="ico">ğŸ“Š</span>Dashboard
        </div>
        <div class="nav-item" data-page="pipeline">
          <span class="ico">ğŸ¯</span>Pipeline
          <span class="nav-badge nb-red" id="bdg-pipeline" style="display:none">0</span>
        </div>

        <div class="nav-section-lbl" style="margin-top:6px">GestÃ£o</div>
        <div class="nav-item" data-page="clientes">
          <span class="ico">ğŸ¤</span>Clientes
        </div>
        <div class="nav-item" data-page="projetos">
          <span class="ico">ğŸ—‚</span>Projetos
          <span class="nav-badge nb-green" id="bdg-projetos" style="display:none">0</span>
        </div>
        <div class="nav-item" data-page="financeiro">
          <span class="ico">ğŸ’°</span>Financeiro
          <span class="nav-badge nb-orange" id="bdg-fin" style="display:none">0</span>
        </div>
        <div class="nav-item" data-page="tickets">
          <span class="ico">ğŸ«</span>Tickets
          <span class="nav-badge nb-red" id="bdg-tickets" style="display:none">0</span>
        </div>

        <div class="nav-section-lbl" style="margin-top:6px">IA</div>
        <div class="nav-item" data-page="ia">
          <span class="ico">ğŸ¤–</span>IA Executiva
        </div>

        <div class="nav-section-lbl" style="margin-top:6px">Sistema</div>
        <div class="nav-item" data-page="config-app">
          <span class="ico">âš™</span>ConfiguraÃ§Ãµes
        </div>
      </nav>

      <div class="sb-foot">
        <div class="user-chip">
          <div class="user-av" id="user-av">?</div>
          <div style="flex:1;min-width:0">
            <div class="user-name" id="user-name">â€”</div>
            <div class="user-role" id="user-role">AM Consultoria</div>
          </div>
          <div class="logout-x" onclick="doLogout()" title="Sair">âœ•</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div id="main">
      <div id="topbar">
        <div class="page-title" id="page-title">Dashboard</div>
        <div id="topbar-actions"></div>
      </div>
      <div id="content">
        <div class="loading">
          <div class="spinner"></div>Carregando...
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- MODAL ROOT -->
  <div id="modal-root"></div>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUPABASE CONFIG
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const CFG_KEY = 'amcrm_config';
    const IA_HIST_KEY = 'amcrm_ia_hist';
    let SB = null; // supabase client
    let CURRENT_USER = null;
    let CONFIG = {};

    function loadConfig() {
      try { return JSON.parse(localStorage.getItem(CFG_KEY)) || {}; }
      catch { return {}; }
    }
    function saveConfigStore(cfg) { localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
    function clearConfig() {
      localStorage.removeItem(CFG_KEY);
      location.reload();
    }

    async function saveConfig() {
      const url = document.getElementById('sb-url').value.trim();
      const key = document.getElementById('sb-key').value.trim();
      const err = document.getElementById('cfg-err');
      if (!url || !key) { err.textContent = 'URL e Anon Key sÃ£o obrigatÃ³rios.'; err.style.display = 'block'; return; }
      err.style.display = 'none';
      saveConfigStore({ supabaseUrl: url, supabaseKey: key });
      location.reload();
    }

    function initSupabase() {
      CONFIG = loadConfig();
      if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
        document.getElementById('config-screen').style.display = 'flex';
        return false;
      }
      SB = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
      document.getElementById('config-screen').style.display = 'none';
      return true;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTH
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function doLogin() {
      const email = document.getElementById('l-email').value.trim();
      const pass = document.getElementById('l-pass').value;
      const btn = document.getElementById('login-btn');
      const err = document.getElementById('login-err');
      err.style.display = 'none'; btn.disabled = true; btn.textContent = 'Entrando...';
      const { data, error } = await SB.auth.signInWithPassword({ email, password: pass });
      btn.disabled = false; btn.textContent = 'Entrar';
      if (error) { err.textContent = error.message; err.style.display = 'block'; return; }
      CURRENT_USER = data.user;
      enterApp();
    }

    async function doLogout() {
      await SB.auth.signOut();
      CURRENT_USER = null;
      document.getElementById('app').classList.remove('visible');
      document.getElementById('app').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('login-screen').style.display = 'flex';
      }, 300);
    }

    async function checkSession() {
      const { data } = await SB.auth.getSession();
      if (data?.session?.user) {
        CURRENT_USER = data.session.user;
        enterApp();
      } else {
        document.getElementById('login-screen').style.display = 'flex';
      }
    }

    async function enterApp() {
      document.getElementById('login-screen').style.display = 'none';
      const app = document.getElementById('app');
      app.classList.add('visible');

      // Preenche user info
      const profile = await getProfile();
      const name = profile?.nome_completo || CURRENT_USER?.email?.split('@')[0] || 'UsuÃ¡rio';
      document.getElementById('user-name').textContent = name;
      document.getElementById('user-av').textContent = name[0]?.toUpperCase() || 'U';
      document.getElementById('user-role').textContent = profile?.cargo || 'AM Consultoria';

      await updateBadges();
      navigate('dashboard');
    }

    async function getProfile() {
      try {
        const { data } = await SB.from('crm_profiles').select('*').eq('id', CURRENT_USER.id).single();
        return data;
      } catch { return null; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ROUTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let currentPage = 'dashboard';

    function navigate(page) {
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.toggle('active', el.dataset.page === page);
      });
      const titles = {
        dashboard: 'Dashboard', pipeline: 'Pipeline de Vendas',
        clientes: 'Clientes', projetos: 'Projetos', financeiro: 'Financeiro',
        tickets: 'Tickets & Suporte', ia: 'IA Executiva', 'config-app': 'ConfiguraÃ§Ãµes'
      };
      document.getElementById('page-title').textContent = titles[page] || page;
      document.getElementById('topbar-actions').innerHTML = '';

      const pages = {
        dashboard: pgDashboard, pipeline: pgPipeline, clientes: pgClientes,
        projetos: pgProjetos, financeiro: pgFinanceiro, tickets: pgTickets,
        ia: pgIA, 'config-app': pgConfig
      };
      const el = document.getElementById('content');
      el.innerHTML = `<div class="loading"><div class="spinner"></div>Carregando...</div>`;
      if (pages[page]) pages[page](el);
    }

    document.querySelectorAll('.nav-item[data-page]').forEach(el => {
      el.addEventListener('click', () => navigate(el.dataset.page));
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BADGES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function updateBadges() {
      try {
        const [{ count: pl }, { count: pr }, { count: fi }, { count: tk }] = await Promise.all([
          SB.from('crm_leads').select('*', { count: 'exact', head: true }).not('stage', 'in', '("fechado","perdido")').then(res => res, () => ({ count: 0 })),
          SB.from('crm_projetos').select('*', { count: 'exact', head: true }).eq('status', 'em_andamento').then(res => res, () => ({ count: 0 })),
          SB.from('crm_contratos').select('*', { count: 'exact', head: true }).eq('status', 'pendente').then(res => res, () => ({ count: 0 })),
          SB.from('crm_tickets').select('*', { count: 'exact', head: true }).in('status', ['aberto', 'em_andamento']).then(res => res, () => ({ count: 0 })),
        ]);
        setBadge('bdg-pipeline', pl); setBadge('bdg-projetos', pr);
        setBadge('bdg-fin', fi); setBadge('bdg-tickets', tk);
      } catch { }
    }
    function setBadge(id, n) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = n || 0;
      el.style.display = n > 0 ? '' : 'none';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HELPERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function fmtBRL(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v) || 0); }
    function fmtDate(d) { if (!d) return 'â€”'; return new Date(d + 'T12:00').toLocaleDateString('pt-BR'); }
    function fmtDateTime(d) { if (!d) return 'â€”'; return new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

    function v(id) { const e = document.getElementById(id); return e ? e.value : ''; }

    function toast(msg, type = 'ok') {
      const t = document.getElementById('toast');
      const d = document.createElement('div');
      d.className = `toast-item toast-${type}`;
      d.textContent = msg; t.appendChild(d);
      setTimeout(() => d.remove(), 3500);
    }

    const SERVICO_BADGE = {
      bi: `<span class="badge bg-blue">ğŸ“Š BI</span>`,
      automacao: `<span class="badge bg-orange">âš™ Auto</span>`,
      ia: `<span class="badge bg-purple">ğŸ¤– IA</span>`,
      combo: `<span class="badge bg-accent">ğŸ”— Combo</span>`,
    };
    function servicoBadge(s) { return SERVICO_BADGE[s] || (s ? `<span class="badge bg-gray">${s}</span>` : ''); }

    function stageBadge(s) {
      const m = {
        prospeccao: `<span class="badge bg-blue">ProspecÃ§Ã£o</span>`,
        qualificacao: `<span class="badge bg-accent">QualificaÃ§Ã£o</span>`,
        proposta: `<span class="badge bg-purple">Proposta</span>`,
        negociacao: `<span class="badge bg-orange">NegociaÃ§Ã£o</span>`,
        fechado: `<span class="badge bg-green">âœ“ Fechado</span>`,
        perdido: `<span class="badge bg-red">Perdido</span>`,
      };
      return m[s] || `<span class="badge bg-gray">${s || 'â€”'}</span>`;
    }
    function contratoBadge(c) {
      const m = {
        recorrente: `<span class="badge bg-green">Recorrente</span>`,
        pontual: `<span class="badge bg-blue">Pontual</span>`,
        horas: `<span class="badge bg-orange">Banco Horas</span>`,
        parceria: `<span class="badge bg-purple">Parceria</span>`,
      };
      return m[c] || `<span class="badge bg-gray">${c || 'â€”'}</span>`;
    }
    function projStatusBadge(s) {
      const m = {
        backlog: `<span class="badge bg-blue">Backlog</span>`,
        em_progresso: `<span class="badge bg-accent">Em Progresso</span>`,
        revisao: `<span class="badge bg-purple">RevisÃ£o</span>`,
        concluido: `<span class="badge bg-green">ConcluÃ­do</span>`
      };
      return m[s] || `<span class="badge bg-gray">${s || 'â€”'}</span>`;
    }
    function finStatusBadge(s) {
      const m = {
        pago: `<span class="badge bg-green">âœ“ Pago</span>`,
        pendente: `<span class="badge bg-orange">â³ Pendente</span>`,
        ativo: `<span class="badge bg-blue">â— Ativo</span>`,
        cancelado: `<span class="badge bg-red">Cancelado</span>`,
      };
      return m[s] || `<span class="badge bg-gray">${s || 'â€”'}</span>`;
    }
    function ticketStatusBadge(s) {
      const m = {
        aberto: `<span class="badge bg-blue">Aberto</span>`,
        em_andamento: `<span class="badge bg-orange">Em Andamento</span>`,
        resolvido: `<span class="badge bg-green">Resolvido</span>`,
        fechado: `<span class="badge bg-gray">Fechado</span>`,
      };
      return m[s] || `<span class="badge bg-gray">${s || 'â€”'}</span>`;
    }
    function priorityBadge(p) {
      const m = {
        alta: `<span class="badge bg-red">ğŸ”´ Alta</span>`,
        media: `<span class="badge bg-orange">ğŸŸ¡ MÃ©dia</span>`,
        baixa: `<span class="badge bg-green">ğŸŸ¢ Baixa</span>`,
      };
      return m[p] || `<span class="badge bg-gray">${p || 'â€”'}</span>`;
    }
    function progColor(p) {
      if (p < 30) return 'var(--red)'; if (p < 70) return 'var(--orange)'; return 'var(--green)';
    }

    function clienteOptions(selected = '') {
      if (!window._clientes) return `<option value="">Carregando...</option>`;
      return `<option value="">Sem cliente</option>` +
        window._clientes.map(c => `<option value="${c.id}" ${c.id === selected ? 'selected' : ''}>${c.nome}${c.empresa ? ' (' + c.empresa + ')' : ''}</option>`).join('');
    }

    async function preloadClientes() {
      const { data } = await SB.from('crm_clientes').select('id,nome,cidade').order('nome');
      window._clientes = data || [];
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function pgDashboard(el) {
      const [
        { count: totalCli },
        { data: leads },
        { data: projetos },
        { data: contratos },
        { data: tickets },
      ] = await Promise.all([
        SB.from('crm_clientes').select('*', { count: 'exact', head: true }).eq('ativo', true),
        SB.from('crm_leads').select('stage,valor').then(res => res, () => ({ data: [] })),
        SB.from('crm_projetos').select('*').order('criado_em', { ascending: false }).limit(6).then(res => res, () => ({ data: [] })),
        SB.from('crm_contratos').select('*').eq('status', 'pendente').order('data_vencimento').limit(5).then(res => res, () => ({ data: [] })),
        SB.from('crm_tickets').select('*', { count: 'exact', head: true }).in('status', ['aberto', 'em_andamento']).then(res => res, () => ({ count: 0 })),
      ]);

      const leadsAtivos = (leads || []).filter(l => l.stage !== 'fechado' && l.stage !== 'perdido');
      const projAtivos = (projetos || []).filter(p => p.status === 'em_progresso');

      const { data: mrr_data } = await SB.from('crm_contratos').select('valor').eq('tipo', 'recorrente').eq('status', 'ativo').then(res => res, () => ({ data: [] }));
      const mrr = (mrr_data || []).reduce((s, c) => s + Number(c.valor || 0), 0);

      const { data: rec_mes } = await SB.from('crm_contratos').select('valor').eq('status', 'pago')
        .gte('data_vencimento', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0])
        .then(res => res, () => ({ data: [] }));
      const recMes = (rec_mes || []).reduce((s, c) => s + Number(c.valor || 0), 0);

      el.innerHTML = `
    <div class="kpi-grid">
      <div class="kpi" style="--kc:var(--green)">
        <div class="kpi-lbl">Receita do MÃªs</div>
        <div class="kpi-val">${fmtBRL(recMes)}</div>
        <div class="kpi-sub">MRR: ${fmtBRL(mrr)}</div>
        <div class="kpi-ico">ğŸ’µ</div>
      </div>
      <div class="kpi" style="--kc:var(--blue)">
        <div class="kpi-lbl">Clientes Ativos</div>
        <div class="kpi-val">${totalCli || 0}</div>
        <div class="kpi-sub">Cadastrados no CRM</div>
        <div class="kpi-ico">ğŸ¤</div>
      </div>
      <div class="kpi" style="--kc:var(--accent)">
        <div class="kpi-lbl">Leads no Pipeline</div>
        <div class="kpi-val">${leadsAtivos.length}</div>
        <div class="kpi-sub">Valor: ${fmtBRL(leadsAtivos.reduce((s, l) => s + Number(l.valor || 0), 0))}</div>
        <div class="kpi-ico">ğŸ¯</div>
      </div>
      <div class="kpi" style="--kc:var(--purple)">
        <div class="kpi-lbl">Projetos Ativos</div>
        <div class="kpi-val">${projAtivos.length}</div>
        <div class="kpi-sub">Tickets abertos: ${tickets?.count || 0}</div>
        <div class="kpi-ico">ğŸ—‚</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:3fr 2fr;gap:18px;margin-bottom:20px">
      <div class="card">
        <div class="sh mb-14">
          <div class="sh-title" style="font-size:15px">Projetos Recentes</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('projetos')">Ver todos â†’</button>
        </div>
        ${projetos?.length ? `
          <div class="tbl-wrap" style="border:none">
            <table>    <thead>
      <tr>
        <th>Projeto</th>
        <th>Cliente</th>
        <th>Tipo</th>
        <th>Status</th>
        <th>Progresso</th>
        <th>Prazo</th>
        <th style="width:70px"></th>
      </tr>
    </thead>
    <tbody>
      ${projetos && projetos.length ? projetos.map(p => `
        <tr>
          <td class="fw-600">${p.titulo || 'â€”'}</td>
          <td>${(window._clientes && window._clientes.find(c => c.id === p.cliente_id)?.nome) || 'â€”'}</td>
          <td><span class="badge bg-gray">${p.tipo || 'â€”'}</span></td>
          <td>${projStatusBadge(p.status)}</td>
          <td>
            <div class="flex items-center gap-8">
              <span class="text-xs" style="width:28px">${p.progresso || 0}%</span>
              <div class="prog-bar w-full"><div class="prog-fill" style="width:${p.progresso || 0}%;background:${progColor(p.progresso || 0)}"></div></div>
            </div>
          </td>
          <td class="text-xs">${fmtDate(p.prazo)}</td>
          <td><button class="btn btn-ghost btn-sm" onclick="openModalProj('${p.id}')">Abrir</button></td>
        </tr>
      `).join('') : `<tr><td colspan="7" class="text-center text-muted" style="padding:40px">Nenhum projeto encontrado.</td></tr>`}
    </tbody>
            </table>
          </div>
        ` : `<div class="empty" style="padding:30px"><div class="ei">ğŸ—‚</div><p>Nenhum projeto ainda</p></div>`}
      </div>
      <div class="card">
        <div class="sh mb-14">
          <div class="sh-title" style="font-size:15px">Vencimentos PrÃ³ximos</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('financeiro')">Ver todos â†’</button>
        </div>
        ${contratos?.length ? contratos.map(f => `
          <div class="flex items-center gap-12" style="padding:10px 0;border-bottom:1px solid var(--border)">
            <div style="flex:1">
              <div class="fw-600" style="font-size:13px">${f.descricao || 'â€”'}</div>
              <div class="text-xs">${f.cliente_nome || 'â€”'}</div>
            </div>
            <div class="fw-700" style="color:var(--orange);font-size:12.5px">${fmtBRL(f.valor)}</div>
            <div class="text-xs">${fmtDate(f.data_vencimento)}</div>
          </div>`).join('') : `<div class="empty" style="padding:30px"><div class="ei">ğŸ’°</div><p>Nada pendente</p></div>`}
      </div>
    </div>`;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PIPELINE (usa tabela crm_leads â€” criar se nÃ£o existir)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const STAGES = [
      { id: 'prospeccao', label: 'ProspecÃ§Ã£o', color: '#5b9cf6' },
      { id: 'qualificacao', label: 'QualificaÃ§Ã£o', color: '#c8a96e' },
      { id: 'proposta', label: 'Proposta', color: '#9b72cf' },
      { id: 'negociacao', label: 'NegociaÃ§Ã£o', color: '#e8884a' },
      { id: 'fechado', label: 'Fechado âœ“', color: '#4caf82' },
      { id: 'perdido', label: 'Perdido âœ—', color: '#e05c6a' },
    ];

    async function pgPipeline(el) {
      const { data: leads, error } = await SB.from('crm_leads').select('*').order('criado_em', { ascending: false });

      if (error?.code === '42P01') {
        // Tabela nÃ£o existe: mostra SQL para criar
        el.innerHTML = `
      <div class="card" style="max-width:640px">
        <div class="sh-title mb-14">Criar tabela de Leads</div>
        <p style="color:var(--text2);font-size:13.5px;margin-bottom:16px">A tabela <code>crm_leads</code> nÃ£o existe ainda. Execute o SQL abaixo no <b>SQL Editor do Supabase</b>:</p>
        <pre style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:16px;font-size:12px;overflow-x:auto;color:var(--green)">${SQL_LEADS}</pre>
        <button class="btn btn-primary" style="margin-top:16px" onclick="navigate('pipeline')">âœ“ JÃ¡ criei â€” Recarregar</button>
      </div>`;
        return;
      }

      const totalVal = (leads || []).filter(l => l.stage !== 'perdido').reduce((s, l) => s + Number(l.valor || 0), 0);
      const winVal = (leads || []).filter(l => l.stage === 'fechado').reduce((s, l) => s + Number(l.valor || 0), 0);
      const conv = leads?.length ? Math.round((leads || []).filter(l => l.stage === 'fechado').length / leads.length * 100) : 0;

      el.innerHTML = `
    <div class="flex items-center gap-12 mb-20" style="flex-wrap:wrap">
      <div class="card card-sm" style="min-width:160px"><div class="text-xs">Pipeline Total</div><div class="fw-700 font-serif" style="font-size:18px;color:var(--accent)">${fmtBRL(totalVal)}</div></div>
      <div class="card card-sm" style="min-width:160px"><div class="text-xs">Receita Fechada</div><div class="fw-700 font-serif" style="font-size:18px;color:var(--green)">${fmtBRL(winVal)}</div></div>
      <div class="card card-sm" style="min-width:120px"><div class="text-xs">ConversÃ£o</div><div class="fw-700 font-serif" style="font-size:18px">${conv}%</div></div>
      <div style="margin-left:auto"><button class="btn btn-primary" onclick="modalNovoLead()">ï¼‹ Novo Lead</button></div>
    </div>
    <div class="kanban-wrap">
      ${STAGES.map(s => {
        const cards = (leads || []).filter(l => l.stage === s.id);
        return `
          <div class="k-col">
            <div class="k-head">
              <div class="k-dot" style="background:${s.color}"></div>
              <div class="k-title">${s.label}</div>
              <div class="k-cnt">${cards.length}</div>
            </div>
            <div class="k-cards">
              ${cards.map(l => `
                <div class="k-card" onclick="modalEditLead('${l.id}')">
                  <div class="k-card-title">${l.nome || 'â€”'}</div>
                  <div class="k-card-sub">${l.empresa || 'Sem empresa'}</div>
                  <div style="margin-bottom:7px">${servicoBadge(l.servico)}</div>
                  <div class="k-card-foot">
                    <div class="k-card-val">${l.valor ? fmtBRL(l.valor) : 'A definir'}</div>
                    <div class="k-card-date">${l.prazo ? fmtDate(l.prazo) : 'â€”'}</div>
                  </div>
                </div>`).join('')}
            </div>
            ${s.id !== 'fechado' && s.id !== 'perdido' ? `<button class="k-add" onclick="modalNovoLead('${s.id}')">+ Lead</button>` : ''}
          </div>`;
      }).join('')}
    </div>`;
    }

    const SQL_LEADS = `CREATE TABLE IF NOT EXISTS crm_leads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome TEXT NOT NULL,
  empresa TEXT, contato TEXT, email TEXT, tel TEXT,
  origem TEXT, servico TEXT,
  valor NUMERIC(12,2) DEFAULT 0,
  prazo DATE,
  stage TEXT DEFAULT 'prospeccao',
  obs TEXT,
  criado_em TIMESTAMPTZ DEFAULT NOW(),
  atualizado_em TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE crm_leads ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_all" ON crm_leads FOR ALL USING (true) WITH CHECK (true);`;

    async function modalNovoLead(stage = 'prospeccao') {
      await preloadClientes();
      showModal('Novo Lead', `
    <div class="fr fr-2"><div class="field"><label>Nome / Empresa *</label><input id="f-nome" placeholder="Empresa XYZ"></div><div class="field"><label>Empresa</label><input id="f-empresa"></div></div>
    <div class="fr fr-2"><div class="field"><label>Contato</label><input id="f-contato"></div><div class="field"><label>E-mail</label><input id="f-email" type="email"></div></div>
    <div class="fr fr-3">
      <div class="field"><label>ServiÃ§o</label><select id="f-servico"><option value="">Selecione</option><option value="bi">ğŸ“Š BI</option><option value="automacao">âš™ AutomaÃ§Ã£o</option><option value="ia">ğŸ¤– IA</option><option value="combo">ğŸ”— Combo</option></select></div>
      <div class="field"><label>Valor Estimado</label><input id="f-valor" type="number" placeholder="0"></div>
      <div class="field"><label>PrevisÃ£o Fechamento</label><input id="f-prazo" type="date"></div>
    </div>
    <div class="fr fr-2">
      <div class="field"><label>Origem</label><select id="f-origem"><option value="">Selecione</option><option>IndicaÃ§Ã£o</option><option>LinkedIn</option><option>WhatsApp</option><option>Site</option><option>Evento</option><option>ProspecÃ§Ã£o ativa</option></select></div>
      <div class="field"><label>EstÃ¡gio</label><select id="f-stage">${STAGES.filter(s => s.id !== 'fechado' && s.id !== 'perdido').map(s => `<option value="${s.id}" ${s.id === stage ? 'selected' : ''}>${s.label}</option>`).join('')}</select></div>
    </div>
    <div class="fr fr-1"><div class="field"><label>ObservaÃ§Ãµes</label><textarea id="f-obs" placeholder="Dores, contexto, prÃ³ximos passos..."></textarea></div></div>
  `, async () => {
        if (!v('f-nome')) return toast('Nome obrigatÃ³rio', 'err');
        const { error } = await SB.from('crm_leads').insert({
          nome: v('f-nome'), empresa: v('f-empresa'), contato: v('f-contato'),
          email: v('f-email'), servico: v('f-servico'), valor: v('f-valor') || null,
          prazo: v('f-prazo') || null, origem: v('f-origem'), stage: v('f-stage'), obs: v('f-obs')
        });
        if (error) { toast(error.message, 'err'); return; }
        toast('Lead criado!'); closeModal(); navigate('pipeline'); updateBadges();
      });
    }

    async function modalEditLead(id) {
      const { data: l } = await SB.from('crm_leads').select('*').eq('id', id).single();
      if (!l) return;
      showModal(l.nome, `
    <div class="flex gap-12 mb-14" style="flex-wrap:wrap">
      ${stageBadge(l.stage)} ${servicoBadge(l.servico)}
      <span class="fw-700" style="color:var(--accent)">${l.valor ? fmtBRL(l.valor) : 'A definir'}</span>
    </div>
    <div class="fr fr-3">
      <div><div class="text-xs">Empresa</div><div class="fw-600">${l.empresa || 'â€”'}</div></div>
      <div><div class="text-xs">Contato</div><div class="fw-600">${l.contato || 'â€”'}</div></div>
      <div><div class="text-xs">Prazo</div><div class="fw-600">${fmtDate(l.prazo)}</div></div>
    </div>
    ${l.obs ? `<div class="card card-sm" style="background:var(--surface2);margin:14px 0"><div class="text-xs mb-8">ObservaÃ§Ãµes</div>${l.obs}</div>` : ''}
    <div class="divider"></div>
    <div class="fr fr-2">
      <div class="field"><label>Mover para EstÃ¡gio</label><select id="f-stage">${STAGES.map(s => `<option value="${s.id}" ${s.id === l.stage ? 'selected' : ''}>${s.label}</option>`).join('')}</select></div>
      <div class="field"><label>Valor (R$)</label><input id="f-valor" type="number" value="${l.valor || ''}"></div>
    </div>
    <div class="fr fr-1"><div class="field"><label>Obs</label><textarea id="f-obs">${l.obs || ''}</textarea></div></div>
  `, async () => {
        const { error } = await SB.from('crm_leads').update({ stage: v('f-stage'), valor: v('f-valor') || null, obs: v('f-obs') }).eq('id', id);
        if (error) { toast(error.message, 'err'); return; }
        toast('Lead atualizado!'); closeModal(); navigate('pipeline'); updateBadges();
      }, async () => {
        if (!confirm(`Excluir lead "${l.nome}"?`)) return;
        await SB.from('crm_leads').delete().eq('id', id);
        toast('Lead removido', 'info'); closeModal(); navigate('pipeline');
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CLIENTES (crm_clientes)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function pgClientes(el) {
      const { data: clientes } = await SB.from('crm_clientes').select('*').order('nome');

      el.innerHTML = `
    <div class="sh">
      <div class="sh-title">Clientes (${clientes?.length || 0})</div>
      <div class="sh-actions">
        <div class="search-wrap"><span>ğŸ”</span><input id="q-cli" placeholder="Buscar..." oninput="filterTbl('q-cli','tbl-cli','cli-row')"></div>
        <button class="btn btn-primary" onclick="modalCliente()">ï¼‹ Novo Cliente</button>
      </div>
    </div>
    ${clientes?.length ? `
      <div class="tbl-wrap">
        <table id="tbl-cli">
          <thead><tr><th>Nome / Empresa</th><th>Segmento</th><th>ServiÃ§os</th><th>Contrato</th><th>Valor/MÃªs</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${clientes.map(c => `
              <tr class="cli-row">
                <td>
                  <div class="fw-600">${c.nome || 'â€”'}</div>
                  <div class="text-xs">${c.empresa || ''}</div>
                </td>
                <td class="text-muted">${c.segmento || 'â€”'}</td>
                <td>${(c.servicos || []).map(servicoBadge).join(' ')}</td>
                <td>${contratoBadge(c.contrato)}</td>
                <td class="fw-700" style="color:var(--accent)">${c.valor_mensal ? fmtBRL(c.valor_mensal) : 'â€”'}</td>
                <td>${c.ativo !== false ? '<span class="badge bg-green">â— Ativo</span>' : '<span class="badge bg-gray">Inativo</span>'}</td>
                <td style="white-space:nowrap">
                  <button class="btn btn-ghost btn-sm" onclick="modalCliente('${c.id}')">âœ</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteCliente('${c.id}','${c.nome?.replace(/'/g, "\\'")}')">ğŸ—‘</button>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    ` : `<div class="empty"><div class="ei">ğŸ¤</div><p>Nenhum cliente ainda.<br>Clique em <b>+ Novo Cliente</b>.</p></div>`}`;
    }

    async function modalCliente(id = null) {
      let c = {};
      if (id) { const { data } = await SB.from('crm_clientes').select('*').eq('id', id).single(); c = data || {}; }
      showModal(id ? `Editar: ${c.nome}` : 'Novo Cliente', `
    <div class="fr fr-2"><div class="field"><label>Nome do ResponsÃ¡vel *</label><input id="f-nome" value="${c.nome || ''}"></div><div class="field"><label>Empresa</label><input id="f-empresa" value="${c.empresa || ''}"></div></div>
    <div class="fr fr-2"><div class="field"><label>E-mail</label><input id="f-email" type="email" value="${c.email || ''}"></div><div class="field"><label>WhatsApp</label><input id="f-tel" value="${c.tel || ''}"></div></div>
    <div class="fr fr-2"><div class="field"><label>Segmento</label><input id="f-seg" value="${c.segmento || ''}" placeholder="ISP, Varejo, SaÃºde..."></div><div class="field"><label>Cidade / Estado</label><input id="f-cidade" value="${c.cidade || ''}" placeholder="Campinas / SP"></div></div>
    <div class="fr fr-1"><div class="field"><label>ServiÃ§os Contratados</label>
      <div class="checks">${[['bi', 'ğŸ“Š BI'], ['automacao', 'âš™ AutomaÃ§Ã£o'], ['ia', 'ğŸ¤– IA'], ['combo', 'ğŸ”— Combo']].map(([val, lbl]) => `<label><input type="checkbox" value="${val}" ${(c.servicos || []).includes(val) ? 'checked' : ''}> ${lbl}</label>`).join('')}</div>
    </div></div>
    <div class="fr fr-3">
      <div class="field"><label>Tipo Contrato</label><select id="f-contrato"><option value="">Selecione</option><option value="recorrente" ${c.contrato === 'recorrente' ? 'selected' : ''}>Recorrente</option><option value="pontual" ${c.contrato === 'pontual' ? 'selected' : ''}>Pontual</option><option value="horas" ${c.contrato === 'horas' ? 'selected' : ''}>Banco Horas</option><option value="parceria" ${c.contrato === 'parceria' ? 'selected' : ''}>Parceria</option></select></div>
      <div class="field"><label>Valor Mensal (R$)</label><input id="f-valor" type="number" value="${c.valor_mensal || ''}"></div>
      <div class="field"><label>Status</label><select id="f-ativo"><option value="true" ${c.ativo !== false ? 'selected' : ''}>Ativo</option><option value="false" ${c.ativo === false ? 'selected' : ''}>Inativo</option></select></div>
    </div>
    <div class="fr fr-1"><div class="field"><label>ObservaÃ§Ãµes</label><textarea id="f-obs">${c.obs || ''}</textarea></div></div>
  `, async () => {
        if (!v('f-nome')) return toast('Nome obrigatÃ³rio', 'err');
        const servicos = [...document.querySelectorAll('#modal-body input[type=checkbox]:checked')].map(x => x.value);
        const payload = {
          nome: v('f-nome'), empresa: v('f-empresa'), email: v('f-email'), tel: v('f-tel'),
          segmento: v('f-seg'), cidade: v('f-cidade'), servicos,
          contrato: v('f-contrato'), valor_mensal: v('f-valor') || null,
          ativo: v('f-ativo') === 'true', obs: v('f-obs')
        };
        const { error } = id
          ? await SB.from('crm_clientes').update(payload).eq('id', id)
          : await SB.from('crm_clientes').insert(payload);
        if (error) { toast(error.message, 'err'); return; }
        toast(id ? 'Cliente atualizado!' : 'Cliente criado!'); closeModal(); navigate('clientes');
      }, id ? async () => {
        if (!confirm(`Excluir cliente?`)) return;
        await SB.from('crm_clientes').delete().eq('id', id);
        toast('Cliente removido', 'info'); closeModal(); navigate('clientes');
      } : null);
    }

    async function deleteCliente(id, nome) {
      if (!confirm(`Excluir cliente "${nome}"?`)) return;
      await SB.from('crm_clientes').delete().eq('id', id);
      toast('Cliente removido', 'info'); navigate('clientes');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROJETOS (crm_projetos)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const PROJ_STATUS = [
      { id: 'backlog', label: 'A Iniciar', color: '#5b9cf6' },
      { id: 'em_progresso', label: 'Em Andamento', color: '#c8a96e' },
      { id: 'revisao', label: 'Em RevisÃ£o', color: '#9b72cf' },
      { id: 'concluido', label: 'ConcluÃ­do', color: '#4caf82' }
    ];

    async function pgProjetos(el) {
      await preloadClientes();
      const { data: projetos } = await SB.from('crm_projetos').select('*').order('criado_em', { ascending: false });

      el.innerHTML = `
    <div class="sh">
      <div class="sh-title">Projetos (${projetos?.length || 0})</div>
      <div class="sh-actions"><button class="btn btn-primary" onclick="openModalProj()">ï¼‹ Novo Projeto</button></div>
    </div>
    <div class="kanban-wrap">
      ${PROJ_STATUS.map(s => {
        const projs = (projetos || []).filter(p => p.status === s.id);
        return `
          <div class="k-col">
            <div class="k-head"><div class="k-dot" style="background:${s.color}"></div><div class="k-title">${s.label}</div><div class="k-cnt">${projs.length}</div></div>
            <div class="k-cards">
              ${projs.map(p => `
                <div class="k-card" onclick="openModalProj('${p.id}')">
                  <div class="k-card-title">${p.nome || 'â€”'}</div>
                  <div class="k-card-sub">${p.cliente_nome || 'Sem cliente'}</div>
                  <div style="margin-bottom:7px">${servicoBadge(p.tipo)}</div>
                  <div class="prog-bar mb-8"><div class="prog-fill" style="width:${p.progresso || 0}%;background:${progColor(p.progresso || 0)}"></div></div>
                  <div class="k-card-foot">
                    <div class="text-xs">${p.progresso || 0}%</div>
                    <div class="k-card-date">${p.prazo ? fmtDate(p.prazo) : 'Sem prazo'}</div>
                  </div>
                </div>`).join('')}
            </div>
            <button class="k-add" onclick="openModalProj(null,'${s.id}')">+ Projeto</button>
          </div>`;
      }).join('')}
    </div>`;
    }

    async function openModalProj(id = '') {
      let p = { titulo: '', cliente_id: '', tipo: '', status: 'backlog', prioridade: 'media', prazo: '', progresso: 0, descricao: '' };
      if (id) { const { data } = await SB.from('crm_projetos').select('*').eq('id', id).single(); p = data || p; }
      showModal(id ? `Editar: ${p.titulo || p.nome || ''}` : 'Novo Projeto', `
    <div class="fr fr-1">
  <div class="field"><label>TÃ­tulo do Projeto *</label><input id="p-titulo" value="${p.titulo || p.nome || ''}"></div>
</div>
<div class="fr fr-2">
  <div class="field"><label>Cliente</label><select id="p-cli">${clienteOptions(p.cliente_id)}</select></div>
  <div class="field"><label>Tipo</label>
    <select id="p-tipo"><option value="bi" ${p.tipo === 'bi' ? 'selected' : ''}>ğŸ“Š BI</option><option value="automacao" ${p.tipo === 'automacao' ? 'selected' : ''}>âš™ AutomaÃ§Ã£o</option><option value="ia" ${p.tipo === 'ia' ? 'selected' : ''}>ğŸ¤– IA</option><option value="combo" ${p.tipo === 'combo' ? 'selected' : ''}>ğŸ”— Combo</option></select></div>
    </div>
    <div class="fr fr-3">
      <div class="field"><label>Status</label><select id="p-st">${PROJ_STATUS.map(s => `<option value="${s.id}" ${p.status === s.id ? 'selected' : ''}>${s.label}</option>`).join('')}</select></div>
      <div class="field"><label>Prazo Final</label><input id="p-prazo" type="date" value="${p.prazo || ''}"></div>
      <div class="field"><label>Progresso (%)</label><input id="p-prog" type="number" min="0" max="100" value="${p.progresso || 0}"></div>
    </div>
    <div class="fr fr-1"><div class="field"><label>Valor (R$)</label><input id="p-valor" type="number" value="${p.valor || ''}"></div></div>
    <div class="fr fr-1"><div class="field"><label>DescriÃ§Ã£o / Escopo</label><textarea id="p-desc">${p.descricao || ''}</textarea></div></div>
  `, async function saveProj() {
        try {
          const titulo = v('p-titulo');
          if (!titulo) return toast('TÃ­tulo Ã© obrigatÃ³rio', 'err');

          const clienteSel = window._clientes?.find(c => c.id === v('p-cli'));
          const payload = {
            nome: titulo, cliente_id: v('p-cli') || null, cliente_nome: clienteSel?.nome || p.cliente_nome || null,
            tipo: v('p-tipo'), status: v('p-st'), progresso: Number(v('p-prog')) || 0,
            prazo: v('p-prazo') || null, valor: v('p-valor') || null, descricao: v('p-desc')
          };
          const { error } = id
            ? await SB.from('crm_projetos').update(payload).eq('id', id)
            : await SB.from('crm_projetos').insert(payload);
          if (error) { toast(error.message, 'err'); return; }

          if (!id && payload.valor && Number(payload.valor) > 0) {
            await SB.from('crm_contratos').insert({
              titulo: `Projeto: ${titulo}`,
              descricao: `Projeto: ${titulo}`,
              cliente_id: payload.cliente_id,
              cliente_nome: payload.cliente_nome,
              tipo: 'pontual',
              valor: payload.valor,
              status: 'pendente',
              data_vencimento: payload.prazo || new Date().toISOString().split('T')[0]
            }).catch(() => { });
          }

          toast(id ? 'Projeto atualizado!' : 'Projeto criado!'); closeModal(); navigate('projetos'); updateBadges();
        } catch (e) { toast(e.message, 'err'); }
      }, id ? async () => {
        if (!confirm('Excluir projeto?')) return;
        await SB.from('crm_projetos').delete().eq('id', id);
        toast('Projeto removido', 'info'); closeModal(); navigate('projetos');
      } : null);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FINANCEIRO (crm_contratos)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function pgFinanceiro(el) {
      await preloadClientes();
      const [
        { data: todos },
        { data: mrr_data },
        { data: pendente_data },
        { data: pago_data },
      ] = await Promise.all([
        SB.from('crm_contratos').select('*').order('data_vencimento', { ascending: false }),
        SB.from('crm_contratos').select('valor').eq('tipo', 'recorrente').eq('status', 'ativo'),
        SB.from('crm_contratos').select('valor').eq('status', 'pendente'),
        SB.from('crm_contratos').select('valor').eq('status', 'pago'),
      ]);

      const mrr = (mrr_data || []).reduce((s, c) => s + Number(c.valor || 0), 0);
      const pendente = (pendente_data || []).reduce((s, c) => s + Number(c.valor || 0), 0);
      const pago = (pago_data || []).reduce((s, c) => s + Number(c.valor || 0), 0);

      el.innerHTML = `
    <div class="fin-grid">
      <div class="fin-card"><div class="fin-lbl">MRR Ativo</div><div class="fin-val" style="color:var(--green)">${fmtBRL(mrr)}</div></div>
      <div class="fin-card"><div class="fin-lbl">A Receber</div><div class="fin-val" style="color:var(--orange)">${fmtBRL(pendente)}</div></div>
      <div class="fin-card"><div class="fin-lbl">Total Recebido</div><div class="fin-val" style="color:var(--blue)">${fmtBRL(pago)}</div></div>
    </div>
    <div class="sh">
      <div class="sh-title">LanÃ§amentos (${todos?.length || 0})</div>
      <div class="sh-actions">
        <div class="search-wrap"><span>ğŸ”</span><input id="q-fin" placeholder="Buscar..." oninput="filterTbl('q-fin','tbl-fin','fin-row')"></div>
        <button class="btn btn-primary" onclick="modalLancamento()">ï¼‹ Novo LanÃ§amento</button>
      </div>
    </div>
    ${todos?.length ? `
      <div class="tbl-wrap">
        <table id="tbl-fin">
          <thead><tr><th>DescriÃ§Ã£o</th><th>Cliente</th><th>Tipo</th><th>Valor</th><th>Vencimento</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${todos.map(f => `
              <tr class="fin-row">
                <td class="fw-600">${f.titulo || f.descricao || 'â€”'}</td>
                <td class="text-muted">${f.cliente_nome || 'â€”'}</td>
                <td>${f.tipo === 'recorrente' ? '<span class="badge bg-green">Recorrente</span>' : f.tipo === 'pontual' ? '<span class="badge bg-blue">Pontual</span>' : '<span class="badge bg-orange">Hora</span>'}</td>
                <td class="fw-700" style="color:var(--accent)">${fmtBRL(f.valor)}</td>
                <td class="text-muted">${fmtDate(f.data_vencimento)}</td>
                <td>${finStatusBadge(f.status)}</td>
                <td style="white-space:nowrap">
                  <button class="btn btn-ghost btn-sm" onclick="togglePago('${f.id}','${f.status}')">${f.status === 'pago' ? 'â†© Reabrir' : 'âœ“ Pago'}</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteFin('${f.id}')">ğŸ—‘</button>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    ` : `<div class="empty"><div class="ei">ğŸ’°</div><p>Nenhum lanÃ§amento ainda.</p></div>`}`;
    }

    async function modalLancamento(id = null) {
      let f = {};
      if (id) { const { data } = await SB.from('crm_contratos').select('*').eq('id', id).single(); f = data || {}; }
      showModal('Novo LanÃ§amento', `
    <div class="fr fr-1">
  <div class="field"><label>TÃ­tulo / ServiÃ§o *</label><input id="f-desc" value="${f.titulo || ''}"></div>
</div>
    <div class="fr fr-2">
      <div class="field"><label>Cliente</label><select id="f-cliente">${clienteOptions(f.cliente_id)}</select></div>
      <div class="field"><label>Tipo</label><select id="f-tipo"><option value="recorrente" ${f.tipo === 'recorrente' ? 'selected' : ''}>Recorrente (MRR)</option><option value="pontual" ${f.tipo === 'pontual' ? 'selected' : ''}>Pontual</option><option value="hora" ${f.tipo === 'hora' ? 'selected' : ''}>Hora Extra</option></select></div>
    </div>
    <div class="fr fr-3">
      <div class="field"><label>Valor Mensal (R$)</label><input id="f-val" type="number" step="0.01" value="${f.valor_mensal || 0}"></div>
  <div class="field"><label>Vencimento / Fim</label><input id="f-venc" type="date" value="${f.fim || f.data_vencimento || ''}"></div>
  <div class="field"><label>Status da CobranÃ§a</label>
    <select id="f-st"><option value="pendente" ${f.status === 'pendente' ? 'selected' : ''}>Pendente</option><option value="pago" ${f.status === 'pago' ? 'selected' : ''}>Pago</option><option value="ativo" ${f.status === 'ativo' ? 'selected' : ''}>Ativo</option><option value="cancelado" ${f.status === 'cancelado' ? 'selected' : ''}>Cancelado</option></select></div>
    </div>
  `, async () => {
        if (!v('f-desc') || !v('f-val') || !v('f-venc')) return toast('Preencha os campos obrigatÃ³rios', 'err');
        const clienteSel = window._clientes?.find(c => c.id === v('f-cliente'));
        const { error } = await SB.from('crm_contratos').insert({
          titulo: v('f-desc'), descricao: v('f-desc'),
          cliente_id: v('f-cliente') || null, cliente_nome: clienteSel?.nome || null,
          tipo: v('f-tipo'), valor: v('f-val'),
          data_vencimento: v('f-venc'), status: v('f-st')
        });
        if (error) { toast(error.message, 'err'); return; }
        toast('LanÃ§amento criado!'); closeModal(); navigate('financeiro'); updateBadges();
      });
    }

    async function togglePago(id, status) {
      const novo = status === 'pago' ? 'pendente' : 'pago';
      await SB.from('crm_contratos').update({ status: novo }).eq('id', id);
      toast(novo === 'pago' ? 'Marcado como pago!' : 'Reaberto'); navigate('financeiro');
    }

    async function deleteFin(id) {
      if (!confirm('Excluir lanÃ§amento?')) return;
      await SB.from('crm_contratos').delete().eq('id', id);
      toast('Removido', 'info'); navigate('financeiro');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TICKETS (crm_tickets + crm_interacoes)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function pgTickets(el) {
      await preloadClientes();
      const { data: tickets } = await SB.from('crm_tickets').select('*').order('criado_em', { ascending: false });

      el.innerHTML = `
    <div class="sh">
      <div class="sh-title">Tickets (${tickets?.length || 0})</div>
      <div class="sh-actions">
        <div class="search-wrap"><span>ğŸ”</span><input id="q-tk" placeholder="Buscar..." oninput="filterTbl('q-tk','tbl-tk','tk-row')"></div>
        <button class="btn btn-primary" onclick="openModalTk()">ï¼‹ Novo Ticket</button>
      </div>
    </div>
    ${tickets?.length ? `
      <div class="tbl-wrap">
        <table id="tbl-tk">
          <thead>
      <tr>
        <th>Ticket</th>
        <th>Cliente</th>
        <th>Prioridade</th>
        <th>Abertura</th>
        <th>Status</th>
        <th style="width:70px"></th>
      </tr>
    </thead>
    <tbody>
      ${tickets && tickets.length ? tickets.map(t => `
        <tr>
          <td class="fw-600">${t.titulo || 'â€”'}</td>
          <td>${(window._clientes && window._clientes.find(cli => cli.id === t.cliente_id)?.nome) || 'â€”'}</td>
          <td>${priorityBadge(t.prioridade)}</td>
          <td class="text-xs">${fmtDate(t.criado || t.created_at)}</td>
          <td>${ticketStatusBadge(t.status)}</td>
          <td>
            <button class="btn btn-ghost btn-sm" onclick="openModalTk('${t.id}')">âœ Ver</button>
          </td>
        </tr>`).join('') : `<tr><td colspan="6" class="text-center text-muted" style="padding:40px">Nenhum ticket encontrado.</td></tr>`}
    </tbody>
        </table>
      </div>
    ` : `<div class="empty"><div class="ei">ğŸ«</div><p>Nenhum ticket ainda.<br>Clique em <b>+ Novo Ticket</b>.</p></div>`}`;
    }

    async function openModalTk(id = '') {
      let [t, ints] = [{ titulo: '', cliente_id: '', prioridade: 'media', status: 'aberto', descricao: '' }, []];
      if (id) {
        const [resT, resI] = await Promise.all([
          SB.from('crm_tickets').select('*').eq('id', id).single(),
          SB.from('crm_interacoes').select('*').eq('ticket_id', id).order('criado_em', { ascending: true })
        ]);
        if (resT.data) t = resT.data;
        if (resI.data) ints = resI.data;
      }
      showModal(id ? `Ticket: ${t.titulo}` : 'Novo Ticket', `
    <div class="fr fr-1"><div class="field"><label>TÃ­tulo *</label><input id="t-titulo" value="${t.titulo || ''}" placeholder="Descreva o problema ou solicitaÃ§Ã£o"></div></div>
    <div class="fr fr-3">
      <div class="field"><label>Cliente</label><select id="t-cli">${clienteOptions(t.cliente_id)}</select></div>
      <div class="field"><label>Prioridade</label><select id="t-prio"><option value="baixa" ${t.prioridade === 'baixa' ? 'selected' : ''}>ğŸŸ¢ Baixa</option><option value="media" ${t.prioridade === 'media' || !t.prioridade ? 'selected' : ''}>ğŸŸ¡ MÃ©dia</option><option value="alta" ${t.prioridade === 'alta' ? 'selected' : ''}>ğŸ”´ Alta</option></select></div>
      <div class="field"><label>Status</label><select id="t-st"><option value="aberto" ${t.status === 'aberto' || !t.status ? 'selected' : ''}>Aberto</option><option value="em_andamento" ${t.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option><option value="resolvido" ${t.status === 'resolvido' ? 'selected' : ''}>Resolvido</option></select></div>
    </div>
    <div class="fr fr-1"><div class="field"><label>DescriÃ§Ã£o</label><textarea id="t-desc">${t.descricao || ''}</textarea></div></div>
    ${id && ints.length ? `
      <div class="divider"></div>
      <div class="text-xs mb-8">HistÃ³rico (${ints.length})</div>
      ${ints.map(i => `
        <div class="interacao-item">
              <div class="int-header">
                <span class="int-autor">${i.autor || 'Sistema'}</span>
                <span class="int-data">${fmtDateTime(i.criado_em)}</span>
              </div>
              <div class="int-texto">${(i.texto || '').replace(/\n/g, '<br>')}</div>
        </div>`).join('')}
      <div class="fr fr-1"><div class="field"><label>Nova InteraÃ§Ã£o</label><textarea id="t-int" placeholder="AtualizaÃ§Ãµes, resposta, progresso..."></textarea></div></div>
    ` : id ? `<div class="fr fr-1"><div class="field"><label>Primeira InteraÃ§Ã£o</label><textarea id="t-int" placeholder="Contexto adicional..."></textarea></div></div>` : ''}
  `, async function saveTk() {
        try {
          const titulo = v('t-titulo');
          if (!titulo) return toast('TÃ­tulo Ã© obrigatÃ³rio', 'err');

          const clienteSel = window._clientes?.find(c => c.id === v('t-cli'));
          const payload = {
            titulo, cliente_id: v('t-cli') || null, cliente_nome: clienteSel?.nome || t.cliente_nome || null,
            prioridade: v('t-prio'), status: v('t-st'), descricao: v('t-desc')
          };
          let ticketId = id;
          if (id) {
            await SB.from('crm_tickets').update(payload).eq('id', id);
          } else {
            const { data } = await SB.from('crm_tickets').insert(payload).select().single();
            ticketId = data?.id;
          }
          const intTxt = v('t-int');
          if (intTxt && ticketId) {
            const userName = document.getElementById('user-name').textContent;
            await SB.from('crm_interacoes').insert({ ticket_id: ticketId, texto: intTxt, autor: userName });
          }
          toast(id ? 'Ticket atualizado!' : 'Ticket criado!'); closeModal(); navigate('tickets'); updateBadges();
        } catch (e) { toast(e.message, 'err'); }
      }, id ? async () => {
        if (!confirm('Excluir ticket?')) return;
        await SB.from('crm_tickets').delete().eq('id', id);
        toast('Ticket removido', 'info'); closeModal(); navigate('tickets');
      } : null);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       IA EXECUTIVA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function pgIA(el) {
      const hist = JSON.parse(localStorage.getItem(IA_HIST_KEY) || '[]');

      el.innerHTML = `
    <div class="ia-wrap">
      <div style="margin-bottom:14px;font-size:13px;color:var(--text2)">
        IA conectada em tempo real aos dados do Supabase. Ela lÃª clientes, projetos, pipeline e financeiro antes de responder.
      </div>
      <div class="ia-msgs" id="ia-msgs">
        ${hist.length === 0 ? `
          <div class="ia-msg">
            <div class="ia-av ai">A</div>
            <div class="ia-bubble assistant">OlÃ¡! Sou a IA Executiva da AM Consultoria. Posso analisar seus dados em tempo real â€” clientes, pipeline, projetos e financeiro. O que quer saber?</div>
          </div>` : hist.map(m => `
          <div class="ia-msg ${m.role}">
            <div class="ia-av ${m.role === 'assistant' ? 'ai' : 'usr'}">${m.role === 'assistant' ? 'A' : 'V'}</div>
            <div class="ia-bubble ${m.role}">${m.content}</div>
          </div>`).join('')}
      </div>
      <div class="ia-input-row">
        <textarea id="ia-inp" rows="1" placeholder="Pergunte qualquer coisa sobre seu negÃ³cio... (Enter = enviar)"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendIA()}"></textarea>
        <button class="btn btn-primary" onclick="sendIA()">Enviar â†’</button>
      </div>
      <div class="ia-quick">
        ${['Qual o status do pipeline?', 'Quais clientes tÃªm MRR?', 'Quais projetos estÃ£o atrasados?', 'Qual meu faturamento mensal?', 'Tickets abertos crÃ­ticos?']
          .map(s => `<button class="btn btn-outline btn-sm" onclick="quickIA('${s}')">${s}</button>`).join('')}
      </div>
    </div>`;
      scrollIA();
    }

    function scrollIA() { const m = document.getElementById('ia-msgs'); if (m) m.scrollTop = m.scrollHeight; }

    async function buildIAContext() {
      const [
        { data: clientes }, { data: leads }, { data: projetos },
        { data: contratos }, { data: tickets }
      ] = await Promise.all([
        SB.from('crm_clientes').select('nome,servicos,valor_mensal,ativo'),
        SB.from('crm_leads').select('nome,servico,valor,stage').then(res => res, () => ({ data: [] })),
        SB.from('crm_projetos').select('nome,tipo,status,progresso,prazo'),
        SB.from('crm_contratos').select('descricao,tipo,valor,status,data_vencimento'),
        SB.from('crm_tickets').select('titulo,prioridade,status'),
      ]);

      const mrr = (contratos || []).filter(c => c.tipo === 'recorrente' && c.status === 'ativo').reduce((s, c) => s + Number(c.valor || 0), 0);
      const pendente = (contratos || []).filter(c => c.status === 'pendente').reduce((s, c) => s + Number(c.valor || 0), 0);
      const pipelineVal = (leads || []).filter(l => l.stage !== 'perdido').reduce((s, l) => s + Number(l.valor || 0), 0);

      return `
CLIENTES (${(clientes || []).length}):
${(clientes || []).map(c => `- ${c.nome} | ${c.empresa || 's/empresa'} | ${(c.servicos || []).join(',') || 'â€”'} | ${c.contrato || 'â€”'} | R$${c.valor_mensal || 0}/mÃªs | ${c.ativo !== false ? 'Ativo' : 'Inativo'}`).join('\n') || 'Nenhum'}

PIPELINE (${(leads || []).length} leads | R$${pipelineVal.toFixed(0)} em aberto):
${(leads || []).map(l => `- ${l.nome} | ${l.empresa || 'â€”'} | ${l.servico || 'â€”'} | R$${l.valor || 0} | ${l.stage}`).join('\n') || 'Nenhum'}

PROJETOS (${(projetos || []).length}):
${(projetos || []).map(p => `- ${p.nome} | ${p.cliente_nome || 'â€”'} | ${p.tipo || 'â€”'} | ${p.status} | ${p.progresso || 0}% | prazo: ${p.prazo || 'â€”'}`).join('\n') || 'Nenhum'}

FINANCEIRO: MRR=R$${mrr.toFixed(2)} | A Receber=R$${pendente.toFixed(2)}
LanÃ§amentos: ${(contratos || []).length} total

TICKETS (${(tickets || []).length}):
${(tickets || []).filter(t => t.status !== 'fechado').map(t => `- [${t.prioridade?.toUpperCase() || 'â€”'}] ${t.titulo} | ${t.cliente_nome || 'â€”'} | ${t.status}`).join('\n') || 'Nenhum aberto'}
  `.trim();
    }

    async function sendIA() {
      const inp = document.getElementById('ia-inp');
      const msg = inp.value.trim();
      if (!msg) return;
      inp.value = '';

      const hist = JSON.parse(localStorage.getItem(IA_HIST_KEY) || '[]');
      hist.push({ role: 'user', content: msg });

      const msgs = document.getElementById('ia-msgs');
      const userBubble = document.createElement('div');
      userBubble.className = 'ia-msg user';
      userBubble.innerHTML = `<div class="ia-av usr">V</div><div class="ia-bubble user">${msg}</div>`;
      msgs.appendChild(userBubble);

      const thinking = document.createElement('div');
      thinking.className = 'ia-msg'; thinking.id = 'ia-thinking';
      thinking.innerHTML = `<div class="ia-av ai">A</div><div class="ia-bubble assistant"><span style="color:var(--text3)">Consultando dados...</span></div>`;
      msgs.appendChild(thinking); scrollIA();

      try {
        const ctx = await buildIAContext();
        const systemPrompt = `VocÃª Ã© a IA Executiva da AM Consultoria â€” uma consultoria especializada em Dados/BI, AutomaÃ§Ã£o de Processos e Agentes de IA. O dono Ã© Alankar. Responda em portuguÃªs, de forma executiva e direta. Use markdown simples quando Ãºtil. Contexto atual do CRM:\n\n${ctx}`;

        const r = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'system', content: systemPrompt },
              ...hist.map(h => ({ role: h.role, content: h.content }))
            ]
          })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.detail || data.error || 'Erro interno no servidor da IA.');

        const reply = data.text || 'Nenhuma resposta recebida.';
        thinking.remove();
        hist.push({ role: 'assistant', content: reply });
        localStorage.setItem(IA_HIST_KEY, JSON.stringify(hist.slice(-30)));

        const bot = document.createElement('div');
        bot.className = 'ia-msg';
        bot.innerHTML = `<div class="ia-av ai">A</div><div class="ia-bubble assistant">${reply.replace(/\n/g, '<br>')}</div>`;
        msgs.appendChild(bot); scrollIA();
      } catch (e) {
        thinking.remove();
        const errB = document.createElement('div');
        errB.className = 'ia-msg';
        errB.innerHTML = `<div class="ia-av ai">A</div><div class="ia-bubble assistant" style="color:var(--red)">Erro: ${e.message}</div>`;
        msgs.appendChild(errB); scrollIA();
      }
    }
    function quickIA(t) { document.getElementById('ia-inp').value = t; sendIA(); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIG PAGE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function pgConfig(el) {
      el.innerHTML = `
    <div style="max-width:560px">
      <div class="card mb-20">
        <div class="sh-title mb-14">Credenciais Supabase</div>
        <div class="fg"><label>Supabase URL</label><input id="cfg-url" value="${CONFIG.supabaseUrl || ''}" placeholder="https://xxxx.supabase.co"></div>
        <div class="fg"><label>Supabase Anon Key</label><input id="cfg-key" value="${CONFIG.supabaseKey || ''}" placeholder="eyJ..."></div>
        <button class="btn btn-primary" onclick="updateConfig()" style="margin-top:10px;">Salvar ConfiguraÃ§Ãµes</button>
      </div>
      <div class="card mb-20">
        <div class="sh-title mb-14">HistÃ³rico IA</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Limpar histÃ³rico de conversas com a IA Executiva.</p>
        <button class="btn btn-danger btn-sm" onclick="clearIAHist()">ğŸ—‘ Limpar HistÃ³rico IA</button>
      </div>
      <div class="card">
        <div class="sh-title mb-14">SQL â€” Tabela crm_leads</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Se o mÃ³dulo Pipeline nÃ£o funcionar, crie a tabela abaixo no SQL Editor do Supabase:</p>
        <pre style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:14px;font-size:11.5px;overflow-x:auto;color:var(--green);line-height:1.6">${SQL_LEADS}</pre>
      </div>
    </div>`;
    }

    function updateConfig() {
      const url = document.getElementById('cfg-url').value.trim();
      const key = document.getElementById('cfg-key').value.trim();
      if (!url || !key) return toast('Preencha os campos obrigatÃ³rios', 'err');
      saveConfigStore({ supabaseUrl: url, supabaseKey: key });
      toast('ConfiguraÃ§Ãµes salvas. Recarregando...');
      setTimeout(() => location.reload(), 1500);
    }

    function clearIAHist() {
      localStorage.removeItem(IA_HIST_KEY);
      toast('HistÃ³rico IA limpo', 'info');
      if (currentPage === 'ia') navigate('ia');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODAL ENGINE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function showModal(title, body, onSave, onDelete) {
      document.getElementById('modal-root').innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-head">
          <div class="modal-title">${title}</div>
          <div class="modal-x" onclick="closeModal()">âœ•</div>
        </div>
        <div class="modal-body" id="modal-body">${body}</div>
        <div class="modal-foot">
          ${onDelete ? `<button class="btn btn-danger btn-sm" onclick="(${onDelete.toString()})()">Excluir</button>` : ''}
          <div style="flex:1"></div>
          <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-primary" onclick="(${onSave.toString()})()">Salvar</button>
        </div>
      </div>
    </div>`;
    }
    function closeModal() { document.getElementById('modal-root').innerHTML = ''; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SEARCH FILTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function filterTbl(inputId, tableId, rowClass) {
      const q = document.getElementById(inputId)?.value.toLowerCase() || '';
      document.querySelectorAll(`.${rowClass}`).forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOOT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    (async () => {
      const ok = initSupabase();
      if (!ok) return;
      await checkSession();
    })();
  </script>
</body>

</html>